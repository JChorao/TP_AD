<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Frota - Car Sharing</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { background-color: #f4f6f9; }
    .container { margin-top: 30px; }
    .table-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    #mapPicker, #mapEditPicker { height: 300px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; }
  </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fa-solid fa-car-rear me-2 text-primary"></i>Gestão de Frota</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
      <i class="fa-solid fa-plus me-1"></i> Adicionar Veículo
    </button>
  </div>

  <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${param.success}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${param.error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="table-card">
    <table class="table table-hover">
      <thead class="table-light">
      <tr>
        <th>Marca/Modelo</th>
        <th>Matrícula</th>
        <th>Preço/Hora</th>
        <th>Localização (Lat, Lng)</th>
        <th>Estado</th>
        <th>Ações</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="vehicle : ${cars}">
        <td th:text="${vehicle.brand + ' ' + vehicle.model}">Toyota Yaris</td>
        <td><span class="badge bg-dark" th:text="${vehicle.licensePlate}">AA-00-BB</span></td>
        <td th:text="${#numbers.formatDecimal(vehicle.pricePerHour, 1, 2) + ' €'}">10.00 €</td>
        <td>
          <small class="text-muted" th:text="${#numbers.formatDecimal(vehicle.latitude, 1, 4) + ', ' + #numbers.formatDecimal(vehicle.longitude, 1, 4)}">0, 0</small>
        </td>
        <td>
          <span th:if="${vehicle.available}" class="badge bg-success">Disponível</span>
          <span th:unless="${vehicle.available}" class="badge bg-danger">Indisponível</span>
        </td>
        <td>
          <button class="btn btn-outline-primary btn-sm me-2"
                  data-bs-toggle="modal"
                  data-bs-target="#editVehicleModal"
                  th:onclick="prepareEditModal([[${vehicle.id}]], [[${vehicle.brand}]], [[${vehicle.model}]], [[${vehicle.licensePlate}]], [[${vehicle.pricePerHour}]], [[${vehicle.latitude}]], [[${vehicle.longitude}]])">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>

          <form th:action="@{/manage-vehicles/delete/{id}(id=${vehicle.id})}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Eliminar este veículo?')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </form>
        </td>
      </tr>
      <tr th:if="${#lists.isEmpty(cars)}">
        <td colspan="6" class="text-center text-muted py-4">Nenhum veículo encontrado na frota.</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="addVehicleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Novo Veículo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form th:action="@{/manage-vehicles/create}" th:object="${newVehicle}" method="post">
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Marca</label>
              <input type="text" th:field="*{brand}" class="form-control" required placeholder="Ex: Renault">
            </div>
            <div class="col-md-6">
              <label class="form-label">Modelo</label>
              <input type="text" th:field="*{model}" class="form-control" required placeholder="Ex: Clio">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Matrícula</label>
              <input type="text" th:field="*{licensePlate}" class="form-control" required placeholder="00-AA-00">
            </div>
            <div class="col-md-6">
              <label class="form-label">Preço por Hora (€)</label>
              <input type="number" step="0.01" th:field="*{pricePerHour}" class="form-control" required placeholder="5.00">
            </div>
          </div>
          <label class="form-label">Localização de Estacionamento (Clique no mapa)</label>
          <div id="mapPicker"></div>
          <div class="row">
            <div class="col-6">
              <input type="text" id="inputLat" th:field="*{latitude}" class="form-control form-control-sm bg-light" readonly required>
            </div>
            <div class="col-6">
              <input type="text" id="inputLng" th:field="*{longitude}" class="form-control form-control-sm bg-light" readonly required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Criar Veículo</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editVehicleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Editar Veículo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form th:action="@{/manage-vehicles/update}" method="post">
        <div class="modal-body">
          <input type="hidden" name="id" id="editId">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Marca</label>
              <input type="text" name="brand" id="editBrand" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Modelo</label>
              <input type="text" name="model" id="editModel" class="form-control" required>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Matrícula</label>
              <input type="text" name="licensePlate" id="editPlate" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Preço por Hora (€)</label>
              <input type="number" step="0.01" name="pricePerHour" id="editPrice" class="form-control" required>
            </div>
          </div>
          <label class="form-label">Nova Localização (Clique no mapa)</label>
          <div id="mapEditPicker"></div>
          <div class="row">
            <div class="col-6">
              <input type="text" id="editLat" name="latitude" class="form-control form-control-sm bg-light" readonly required>
            </div>
            <div class="col-6">
              <input type="text" id="editLng" name="longitude" class="form-control form-control-sm bg-light" readonly required>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Alterações</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
  var pickerMap, pickerMarker;
  var editMap, editMarker;

  // Inicializar o mapa do modal de Adição
  document.getElementById('addVehicleModal').addEventListener('shown.bs.modal', function () {
    if (!pickerMap) {
      pickerMap = L.map('mapPicker').setView([39.8230, -7.4919], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
      pickerMap.on('click', function(e) {
        if (pickerMarker) pickerMarker.setLatLng(e.latlng);
        else pickerMarker = L.marker(e.latlng).addTo(pickerMap);
        document.getElementById('inputLat').value = e.latlng.lat.toFixed(6);
        document.getElementById('inputLng').value = e.latlng.lng.toFixed(6);
      });
    }
    pickerMap.invalidateSize();
  });

  // Função para preencher o modal de Edição
  function prepareEditModal(id, brand, model, plate, price, lat, lng) {
    document.getElementById('editId').value = id;
    document.getElementById('editBrand').value = brand;
    document.getElementById('editModel').value = model;
    document.getElementById('editPlate').value = plate;
    document.getElementById('editPrice').value = price;
    document.getElementById('editLat').value = lat;
    document.getElementById('editLng').value = lng;

    setTimeout(function() {
      if (!editMap) {
        editMap = L.map('mapEditPicker').setView([lat, lng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap);
        editMap.on('click', function(e) {
          if (editMarker) editMarker.setLatLng(e.latlng);
          else editMarker = L.marker(e.latlng).addTo(editMap);
          document.getElementById('editLat').value = e.latlng.lat.toFixed(6);
          document.getElementById('editLng').value = e.latlng.lng.toFixed(6);
        });
      } else {
        editMap.setView([lat, lng], 14);
      }

      if (editMarker) editMarker.setLatLng([lat, lng]);
      else editMarker = L.marker([lat, lng]).addTo(editMap);

      editMap.invalidateSize();
    }, 200);
  }
</script>

</body>
</html>