<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Gerir Veículos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5">
  <h2 class="mb-4">Gestão de Frota</h2>

  <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show">
    <span th:text="${param.success}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show">
    <span th:text="${param.error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="mb-3 text-end">
    <a th:href="@{/vehicles/add}" class="btn btn-primary">
      <i class="fa-solid fa-plus me-2"></i>Novo Veículo
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Matrícula</th>
          <th>Preço/Hora</th>
          <th>Localização (Lat/Lon)</th>
          <th>Estado</th>
          <th>Ações</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="v : ${vehicles}">
          <td th:text="${v.id}">1</td>
          <td th:text="${v.brand}">Toyota</td>
          <td th:text="${v.model}">Yaris</td>
          <td th:text="${v.licensePlate}">AA-00-BB</td>
          <td th:text="${v.pricePerHour} + ' €'">5.0 €</td>
          <td>
            <small class="text-muted" th:text="${v.latitude} + ', ' + ${v.longitude}"></small>
          </td>
          <td>
            <span th:if="${v.available}" class="badge bg-success">Disponível</span>
            <span th:unless="${v.available}" class="badge bg-danger">Ocupado</span>
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-warning me-2"
                    data-bs-toggle="modal"
                    data-bs-target="#editVehicleModal"
                    th:data-id="${v.id}"
                    th:data-brand="${v.brand}"
                    th:data-model="${v.model}"
                    th:data-plate="${v.licensePlate}"
                    th:data-price="${v.pricePerHour}"
                    th:data-lat="${v.latitude}"
                    th:data-lon="${v.longitude}"
                    onclick="fillEditModal(this)">
              <i class="fa-solid fa-pen"></i>
            </button>

            <a th:href="@{/vehicles/delete/{id}(id=${v.id})}"
               class="btn btn-sm btn-danger"
               onclick="return confirm('Tem a certeza que deseja remover este veículo?');">
              <i class="fa-solid fa-trash"></i>
            </a>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="editVehicleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="fa-solid fa-pen-to-square me-2"></i>Editar Veículo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/vehicles/update}" method="post" id="editForm">
          <input type="hidden" name="id" id="modalId">

          <div class="mb-3">
            <label class="form-label">Marca</label>
            <input type="text" name="brand" id="modalBrand" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Modelo</label>
            <input type="text" name="model" id="modalModel" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Matrícula</label>
            <input type="text" name="licensePlate" id="modalPlate" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Preço por Hora (€)</label>
            <input type="number" step="0.01" name="pricePerHour" id="modalPrice" class="form-control" required>
          </div>
          <div class="row">
            <div class="col-6 mb-3">
              <label class="form-label">Latitude</label>
              <input type="number" step="any" name="latitude" id="modalLat" class="form-control" required>
            </div>
            <div class="col-6 mb-3">
              <label class="form-label">Longitude</label>
              <input type="number" step="any" name="longitude" id="modalLon" class="form-control" required>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-warning">Guardar Alterações</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function fillEditModal(button) {
    // Ler os dados dos atributos data-* do botão
    var id = button.getAttribute('data-id');
    var brand = button.getAttribute('data-brand');
    var model = button.getAttribute('data-model');
    var plate = button.getAttribute('data-plate');
    var price = button.getAttribute('data-price');
    var lat = button.getAttribute('data-lat');
    var lon = button.getAttribute('data-lon');

    // Preencher os inputs do modal
    document.getElementById('modalId').value = id;
    document.getElementById('modalBrand').value = brand;
    document.getElementById('modalModel').value = model;
    document.getElementById('modalPlate').value = plate;
    document.getElementById('modalPrice').value = price;
    document.getElementById('modalLat').value = lat;
    document.getElementById('modalLon').value = lon;
  }
</script>

</body>
</html>