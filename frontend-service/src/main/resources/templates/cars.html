<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Veículos - Car Sharing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        body { background-color: #f4f6f9; }
        .main-wrapper { padding: 20px; }
        .map-card {
            width: 100%;
            height: 75vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        #map { height: 100%; width: 100%; }

        .sidebar-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            height: 75vh;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Estilo do Popup do Leaflet */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 10px; padding: 0; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 260px !important; }
        .popup-header { background-color: #0d6efd; color: white; padding: 10px; border-radius: 10px 10px 0 0; text-align: center; }
        .popup-body { padding: 15px; }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid main-wrapper">
    <div th:if="${param.successLoc}" class="alert alert-success alert-dismissible fade show mb-3">
        Localização atualizada com sucesso!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <div class="col-md-9">
            <div class="map-card">
                <div id="map"></div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="sidebar-card d-flex flex-column">
                <h5 class="mb-4 text-primary"><i class="fa-solid fa-location-crosshairs me-2"></i>A Minha Posição</h5>

                <p class="small text-muted mb-4">Clique no mapa para mover o seu marcador verde.</p>

                <form th:action="@{/users/location}" method="post" id="locationForm">
                    <input type="hidden" name="latitude" id="userLat">
                    <input type="hidden" name="longitude" id="userLng">

                    <button type="submit" class="btn btn-success w-100 py-2 mb-3" id="btnSaveLoc" disabled>
                        <i class="fa-solid fa-floppy-disk me-2"></i>Guardar Posição
                    </button>
                </form>

                <hr>

                <button class="btn btn-primary w-100 py-3 shadow-sm mt-2" onclick="findNearestCar()">
                    <i class="fa-solid fa-car-side me-2"></i>Carro Mais Próximo
                </button>

                <div class="mt-auto p-3 bg-light rounded">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fa-solid fa-user text-success me-2"></i> <small>A Minha Localização</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fa-solid fa-car text-primary me-2"></i> <small>Carros Disponíveis</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    var isLoggedIn = [[${isLoggedIn}]];
    var carsList = [[${cars}]];
    var user = [[${user}]]; // Recebe o UserDto da sessão
    var markers = {}; // Objeto para guardar referências aos marcadores dos carros

    // 1. Coordenadas iniciais (User ou Castelo Branco)
    var initialLat = (user && user.latitude) ? user.latitude : 39.8230;
    var initialLng = (user && user.longitude) ? user.longitude : -7.4919;

    var map = L.map('map').setView([initialLat, initialLng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2. Ícone do Utilizador (Verde)
    var userIcon = L.divIcon({
        className: 'custom-div-icon',
        html: "<div style='background-color:#198754; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);'></div>",
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    var userMarker = null;
    if (isLoggedIn) {
        userMarker = L.marker([initialLat, initialLng], {icon: userIcon, draggable: true}).addTo(map);
        userMarker.bindPopup("<b>Eu estou aqui</b>").openPopup();

        // Atualiza inputs ao arrastar
        userMarker.on('dragend', function(e) {
            updatePos(e.target.getLatLng().lat, e.target.getLatLng().lng);
        });
    }

    // Clique no mapa move o user
    map.on('click', function(e) {
        if (isLoggedIn && userMarker) {
            userMarker.setLatLng(e.latlng);
            updatePos(e.latlng.lat, e.latlng.lng);
        }
    });

    function updatePos(lat, lng) {
        document.getElementById('userLat').value = lat;
        document.getElementById('userLng').value = lng;
        document.getElementById('btnSaveLoc').disabled = false;
    }

    // 3. Adicionar Carros
    if (carsList && carsList.length > 0) {
        carsList.forEach(function(car) {
            if (car.latitude && car.longitude && car.available) {
                var m = L.marker([car.latitude, car.longitude]).addTo(map);

                // Form HTML (Simplificado para o exemplo)
                var formHtml = isLoggedIn ?
                    `<form action="/rent-car/${car.id}" method="post">
                        <input type="datetime-local" class="form-control form-control-sm mb-2" name="startTime" required>
                        <input type="datetime-local" class="form-control form-control-sm mb-2" name="endTime" required>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Alugar</button>
                    </form>` : `<a href="/login" class="btn btn-outline-primary btn-sm w-100">Login</a>`;

                var popupContent = `
                    <div class="popup-header"><h6>${car.brand} ${car.model}</h6></div>
                    <div class="popup-body text-center">
                        <small class="badge bg-secondary mb-2">${car.licensePlate}</small><br>
                        ${formHtml}
                    </div>`;

                m.bindPopup(popupContent, {className: 'custom-popup'});
                markers[car.id] = m;
            }
        });
    }

    // 4. Função Encontrar Mais Próximo
    window.findNearestCar = function() {
        if (!userMarker) return alert("Faça login primeiro.");

        var userPos = userMarker.getLatLng();
        var nearest = null;
        var minDist = Infinity;

        carsList.forEach(function(car) {
            if (car.available) {
                var carPos = L.latLng(car.latitude, car.longitude);
                var dist = userPos.distanceTo(carPos);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = car;
                }
            }
        });

        if (nearest) {
            map.flyTo([nearest.latitude, nearest.longitude], 16);
            setTimeout(() => markers[nearest.id].openPopup(), 1000);
        } else {
            alert("Nenhum carro disponível.");
        }
    };
</script>

</body>
</html>