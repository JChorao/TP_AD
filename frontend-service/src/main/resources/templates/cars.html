<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Veículos - Car Sharing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        body {
            background-color: #f4f6f9;
        }

        .main-wrapper {
            padding: 30px;
        }

        .map-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .map-header {
            padding: 20px;
            background-color: white;
            border-bottom: 1px solid #eee;
        }

        #map {
            height: 70vh;
            width: 100%;
        }

        .sidebar-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 10px;
            padding: 0;
        }
        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 260px !important;
        }
        .popup-header {
            background-color: #0d6efd;
            color: white;
            padding: 10px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        .popup-body {
            padding: 15px;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid main-wrapper">
    <div th:if="${param.successLoc}" class="alert alert-success alert-dismissible fade show mb-3">
        Localização atualizada com sucesso!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <div class="col-md-9">
            <div class="map-card">
                <div class="map-header d-flex align-items-center">
                    <h4 class="m-0"><i class="fa-solid fa-map-location-dot me-2 text-primary"></i>Veículos Disponíveis</h4>
                    <span class="badge bg-success ms-auto" th:text="${cars != null ? cars.size() + ' Carros' : '0 Carros'}"></span>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="sidebar-card">
                <h5 class="mb-3 text-primary"><i class="fa-solid fa-location-crosshairs me-2"></i>A Minha Posição</h5>
                <p class="small text-muted">Arraste o pino verde ou clique no mapa para mudar a sua posição.</p>

                <form th:action="@{/users/location}" method="post">
                    <input type="hidden" name="latitude" id="userLat">
                    <input type="hidden" name="longitude" id="userLng">
                    <button type="submit" class="btn btn-success w-100 mb-3" id="btnSaveLoc" disabled>
                        <i class="fa-solid fa-check me-1"></i> Guardar Posição
                    </button>
                </form>

                <button class="btn btn-primary w-100 mb-3" onclick="findNearestCar()">
                    <i class="fa-solid fa-car me-1"></i> Carro Mais Próximo
                </button>

                <div class="p-2 bg-light rounded border">
                    <div class="small mb-1"><i class="fa-solid fa-circle text-success me-2"></i>Sua Localização</div>
                    <div class="small"><i class="fa-solid fa-location-pin text-primary me-2"></i>Veículos</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // --- 1. Dados Iniciais ---
    var isLoggedIn = [[${isLoggedIn}]];
    var carsList = [[${cars}]];
    var user = [[${user}]]; // Recebe o UserDto da sessão
    var markers = {}; // Guardar referências dos marcadores

    // Coordenadas iniciais: do utilizador ou Castelo Branco
    var initialLat = (user && user.latitude) ? user.latitude : 39.8230;
    var initialLng = (user && user.longitude) ? user.longitude : -7.4919;

    var map = L.map('map').setView([initialLat, initialLng], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- 2. Marcador do Utilizador (Verde) ---
    var userIcon = L.divIcon({
        className: 'custom-div-icon',
        html: "<div style='background-color:#198754; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);'></div>",
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });

    var userMarker = null;
    if (isLoggedIn) {
        userMarker = L.marker([initialLat, initialLng], {icon: userIcon, draggable: true}).addTo(map);
        userMarker.bindPopup("<b>Você está aqui</b>").openPopup();

        userMarker.on('dragend', function(e) {
            updatePosFields(e.target.getLatLng().lat, e.target.getLatLng().lng);
        });
    }

    map.on('click', function(e) {
        if (isLoggedIn && userMarker) {
            userMarker.setLatLng(e.latlng);
            updatePosFields(e.latlng.lat, e.latlng.lng);
        }
    });

    function updatePosFields(lat, lng) {
        document.getElementById('userLat').value = lat;
        document.getElementById('userLng').value = lng;
        document.getElementById('btnSaveLoc').disabled = false;
    }

    // --- 3. Função de Cálculo de Preço ---
    window.updatePrice = function(vehicleId, pricePerHour) {
        const startElem = document.getElementById('start-' + vehicleId);
        const endElem = document.getElementById('end-' + vehicleId);
        const displayElem = document.getElementById('total-' + vehicleId);

        if (startElem.value && endElem.value) {
            const startDate = new Date(startElem.value);
            const endDate = new Date(endElem.value);
            const diffMs = endDate - startDate;
            const diffHours = diffMs / (1000 * 60 * 60);

            if (diffHours > 0) {
                const total = diffHours * pricePerHour;
                displayElem.innerText = total.toFixed(2) + ' €';
                displayElem.style.color = '#198754';
            } else {
                displayElem.innerText = 'Datas inválidas';
                displayElem.style.color = '#dc3545';
            }
        }
    };

    // --- 4. Adicionar Marcadores de Carros ---
    if (carsList && carsList.length > 0) {
        carsList.forEach(function(car) {
            if (car.latitude && car.longitude && car.available) {
                var marker = L.marker([car.latitude, car.longitude]).addTo(map);

                var formHtml = isLoggedIn ? `
                    <form action="/rent-car/${car.id}" method="post">
                        <div class="mb-2">
                            <label class="form-label small fw-bold">Início</label>
                            <input type="datetime-local" class="form-control form-control-sm"
                                   name="startTime" id="start-${car.id}" required
                                   onchange="updatePrice(${car.id}, ${car.pricePerHour})">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small fw-bold">Fim</label>
                            <input type="datetime-local" class="form-control form-control-sm"
                                   name="endTime" id="end-${car.id}" required
                                   onchange="updatePrice(${car.id}, ${car.pricePerHour})">
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded border">
                            <span class="small">Total:</span>
                            <strong id="total-${car.id}">0.00 €</strong>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">Alugar</button>
                    </form>`
                    : `<a href="/login" class="btn btn-outline-primary btn-sm w-100">Login para Reservar</a>`;

                var popupContent = `
                    <div class="popup-header"><h6>${car.brand} ${car.model}</h6></div>
                    <div class="popup-body">
                        <div class="mb-3 text-center">
                            <span class="badge bg-secondary">${car.licensePlate}</span>
                            <span class="badge bg-warning text-dark ms-1">${car.pricePerHour.toFixed(2)} €/h</span>
                        </div>
                        ${formHtml}
                    </div>`;

                marker.bindPopup(popupContent, { className: 'custom-popup' });
                markers[car.id] = marker;
            }
        });
    }

    // --- 5. Função Carro Mais Próximo ---
    window.findNearestCar = function() {
        if (!userMarker) return alert("Por favor, faça login.");

        var userPos = userMarker.getLatLng();
        var nearest = null;
        var minDist = Infinity;

        carsList.forEach(function(car) {
            if (car.available) {
                var carPos = L.latLng(car.latitude, car.longitude);
                var dist = userPos.distanceTo(carPos);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = car;
                }
            }
        });

        if (nearest) {
            map.flyTo([nearest.latitude, nearest.longitude], 16);
            setTimeout(() => markers[nearest.id].openPopup(), 1000);
        } else {
            alert("Nenhum veículo disponível no momento.");
        }
    };
</script>

</body>
</html>